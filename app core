<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NNJ Protocol</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22orange%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><circle cx=%2212%22 cy=%2212%22 r=%224%22/><path d=%22M12 2v2%22/><path d=%22M12 20v2%22/><path d=%22m4.93 4.93 1.41 1.41%22/><path d=%22m17.66 17.66 1.41 1.41%22/><path d=%22M2 12h2%22/><path d=%22M20 12h2%22/><path d=%22m6.34 17.66-1.41 1.41%22/><path d=%22m19.07 4.93-1.41 1.41%22/></svg>">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Animations -->
    <style>
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slideUp { animation: slideUp 0.5s ease-out forwards; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Disable selection for app-like feel */
        body { -webkit-user-select: none; user-select: none; }
        input, select { -webkit-user-select: text; user-select: text; }
        
        /* Better mobile tap highlights */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, memo } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "", fill="none" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill={fill} 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            Sun: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />} />,
            Scale: (props) => <Icon {...props} path={<><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            Info: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />,
            ShieldCheck: (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>} />,
            ChevronDown: (props) => <Icon {...props} path={<polyline points="6 9 12 15 18 9" />} />,
            ChevronUp: (props) => <Icon {...props} path={<polyline points="18 15 12 9 6 15" />} />,
            Droplet: (props) => <Icon {...props} path={<path d="M12 2.69l5.74 5.88a6 6 0 0 1-8.49 8.48A6 6 0 0 1 5.25 9.51L12 2.69Z"/>} />,
            List: (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />,
            Clipboard: (props) => <Icon {...props} path={<><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Table: (props) => <Icon {...props} path={<><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7z"/><path d="M3 9h18"/><path d="M12 3v18"/></>} />
        };

        // --- DATA CONSTANTS (VERIFIED) ---
        
        // 1. Term/Near Term NO RISK (Corrected values from image_8fb310.png)
        // Format: [Hour, >=38w, 37w, 36w, 35w]
        const MY_PT_NO_RISK = [
            [6, 101, 94, 84, 58], 
            [12, 121, 113, 103, 94], 
            [24, 159, 149, 140, 130], 
            [48, 222, 212, 202, 191], 
            [72, 270, 258, 248, 236], 
            [96, 303, 291, 279, 267], 
            [120, 306, 294, 280, 268] 
        ];
        
        const MY_ET_NO_RISK = [
            [6, 321, 304, 285, 266],  
            [12, 337, 320, 299, 280], 
            [24, 366, 347, 327, 306], 
            [48, 410, 395, 374, 354], 
            [72, 443, 431, 412, 391], 
            [96, 462, 455, 436, 419], 
            [120, 462, 456, 439, 422] 
        ];

        // 2. Term/Near Term WITH RISK (From PDF Page 137)
        // Format: [Hour, >=38w, 37w, 36w, 35w]
        const MY_PT_RISK = [
            [6, 74, 67, 56, 48], 
            [12, 94, 85, 75, 67], 
            [24, 128, 120, 109, 101], 
            [48, 180, 167, 157, 143], 
            [72, 224, 212, 198, 184], 
            [96, 255, 239, 224, 211], 
            [120, 256, 241, 227, 213] 
        ];
        
        const MY_ET_RISK = [
            [6, 265, 256, 246, 236], 
            [12, 279, 268, 260, 250], 
            [24, 303, 294, 284, 275], 
            [48, 344, 337, 327, 316], 
            [72, 378, 371, 357, 344], 
            [96, 402, 395, 378, 361], 
            [120, 402, 397, 381, 364]
        ];
        
        // 3. Preterm < 35 weeks (Page 138-139)
        // Format: { week: [[Hour, PT, ET], ...] }
        const TABLE_PRETERM = {
            23: [[6, 45, 90], [12, 55, 105], [24, 70, 130], [48, 100, 180], [72, 130, 230], [96, 130, 230]],
            24: [[6, 45, 90], [12, 60, 110], [24, 70, 135], [48, 110, 185], [72, 140, 240], [96, 140, 240]],
            25: [[6, 50, 100], [12, 60, 110], [24, 80, 140], [48, 110, 190], [72, 150, 250], [96, 150, 250]],
            26: [[6, 50, 100], [12, 60, 110], [24, 80, 140], [48, 120, 200], [72, 160, 260], [96, 160, 260]],
            27: [[6, 50, 100], [12, 60, 110], [24, 80, 140], [48, 130, 205], [72, 170, 270], [96, 170, 270]],
            28: [[6, 50, 100], [12, 60, 110], [24, 90, 150], [48, 130, 210], [72, 180, 280], [96, 180, 280]],
            29: [[6, 50, 100], [12, 65, 115], [24, 90, 150], [48, 140, 220], [72, 190, 290], [96, 190, 290]],
            30: [[6, 50, 100], [12, 65, 115], [24, 95, 150], [48, 145, 220], [72, 200, 300], [96, 200, 300]],
            31: [[6, 50, 100], [12, 70, 120], [24, 100, 155], [48, 155, 230], [72, 210, 310], [96, 210, 310]],
            32: [[6, 50, 100], [12, 70, 120], [24, 100, 160], [48, 160, 240], [72, 220, 320], [96, 220, 320]],
            33: [[6, 50, 100], [12, 70, 120], [24, 100, 160], [48, 170, 245], [72, 230, 330], [96, 230, 330]],
            34: [[6, 50, 100], [12, 70, 120], [24, 110, 170], [48, 170, 250], [72, 240, 340], [96, 240, 340]],
        };

        // --- HELPERS ---
        const interpolate = (age, table, colIndex) => {
            let lower = table[0];
            let upper = table[table.length - 1];
            
            // Limit to provided range [6, 120]
            if (age < 6) return null; 
            if (age >= 120) return table[table.length - 1][colIndex];

            for (let i = 0; i < table.length - 1; i++) {
                if (age >= table[i][0] && age <= table[i+1][0]) {
                    lower = table[i];
                    upper = table[i+1];
                    break;
                }
            }
            const ratio = (age - lower[0]) / (upper[0] - lower[0]);
            return lower[colIndex] + ratio * (upper[colIndex] - lower[colIndex]);
        };

        const interpolatePreterm = (age, dataPoints) => {
            let lower = dataPoints[0];
            let upper = dataPoints[dataPoints.length - 1];
            
            // Limit to provided range [6, 96]
            if (age < 6) return null;
            if (age >= 96) return { pt: dataPoints[dataPoints.length - 1][1], et: dataPoints[dataPoints.length - 1][2] };

            for (let i = 0; i < dataPoints.length - 1; i++) {
                if (age >= dataPoints[i][0] && age <= dataPoints[i+1][0]) {
                    lower = dataPoints[i];
                    upper = dataPoints[i+1];
                    break;
                }
            }
            const ratio = (age - lower[0]) / (upper[0] - lower[0]);
            const pt = lower[1] + ratio * (upper[1] - lower[1]);
            const et = lower[2] + ratio * (upper[2] - lower[2]);
            return { pt, et };
        };

        // --- COMPONENTS ---
        const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white/60 backdrop-blur-xl border border-white/50 rounded-2xl shadow-xl overflow-hidden ${className}`}>
                {title && (
                    <div className="bg-white/40 px-5 py-4 md:px-6 border-b border-white/30 backdrop-blur-sm">
                        <h3 className="font-bold text-slate-700 text-base md:text-lg flex items-center justify-center md:justify-start gap-2 text-center md:text-left leading-tight">
                            {title}
                        </h3>
                    </div>
                )}
                <div className="p-4 md:p-6">{children}</div>
            </div>
        );

        const inputClasses = "w-full h-12 md:h-14 p-3 bg-white/50 border border-white/60 rounded-xl focus:ring-2 focus:ring-blue-400/50 focus:bg-white/80 focus:outline-none transition-all text-sm md:text-base text-slate-700 placeholder:text-slate-400";
        const labelClasses = "block text-xs md:text-sm font-bold text-slate-600 uppercase tracking-wider mb-2";

        const ReferenceTable = ({ data, type }) => {
            if (type === 'term') {
                return (
                    <div className="overflow-x-auto">
                        <table className="w-full text-xs text-left text-slate-600">
                            <thead className="bg-slate-100 text-slate-700 uppercase font-bold">
                                <tr>
                                    <th className="px-4 py-2">Age (h)</th>
                                    <th className="px-4 py-2">≥38w</th>
                                    <th className="px-4 py-2">37w</th>
                                    <th className="px-4 py-2">36w</th>
                                    <th className="px-4 py-2">35w</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200">
                                {data.map((row, i) => (
                                    <tr key={i} className="hover:bg-slate-50">
                                        <td className="px-4 py-2 font-bold">{row[0] === 120 ? '>120' : row[0]}</td>
                                        <td className="px-4 py-2">{row[1]}</td>
                                        <td className="px-4 py-2">{row[2]}</td>
                                        <td className="px-4 py-2">{row[3]}</td>
                                        <td className="px-4 py-2">{row[4]}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            }
            return null; 
        };

        const ThresholdGraph = memo(({ gestation, hasRiskFactors, ageHours, tsbUmol, unit }) => {
            const data = useMemo(() => {
                let rawData = [];
                // Extend graph data to 168h for plateau visualization
                if (gestation >= 35) {
                    let colIndex;
                    if (gestation >= 38) colIndex = 1;
                    else if (gestation === 37) colIndex = 2;
                    else if (gestation === 36) colIndex = 3;
                    else colIndex = 4;
                    const ptTable = hasRiskFactors ? MY_PT_RISK : MY_PT_NO_RISK;
                    const etTable = hasRiskFactors ? MY_ET_RISK : MY_ET_NO_RISK;
                    rawData = ptTable.map((row) => {
                        const etRow = etTable.find(r => r[0] === row[0]) || etTable[etTable.length -1];
                        return { x: row[0], pt: row[colIndex], et: etRow[colIndex] };
                    });
                    // Add visual plateau point at 168h
                    rawData.push({ x: 168, pt: rawData[rawData.length-1].pt, et: rawData[rawData.length-1].et });

                } else {
                    const lookupGestation = Math.max(23, Math.min(34, Math.floor(gestation)));
                    const table = TABLE_PRETERM[lookupGestation];
                    rawData = table.map(row => ({ x: row[0], pt: row[1], et: row[2] }));
                    // Add visual plateau point at 168h for preterm
                     rawData.push({ x: 168, pt: rawData[rawData.length-1].pt, et: rawData[rawData.length-1].et });
                }
                return rawData;
            }, [gestation, hasRiskFactors]);

            const width = 100, height = 60, padding = { left: 12, right: 2, top: 5, bottom: 8 };
            const maxX = 168, maxY = 500; // Updated X max to 168 (7 days) for better visualization
            const scaleX = (x) => padding.left + (Math.min(x, maxX) / maxX) * (width - padding.left - padding.right);
            const scaleY = (y) => height - padding.bottom - (y / maxY) * (height - padding.top - padding.bottom);
            const createPath = (key) => data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${scaleX(d.x)} ${scaleY(d[key])}`).join(' ');

            return (
                <div className="w-full aspect-video bg-white/40 backdrop-blur-sm rounded-xl border border-white/50 p-1 md:p-2 select-none relative mt-2 shadow-inner">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full text-xs">
                        {[0, 100, 200, 300, 400, 500].map(val => (
                            <g key={val}>
                                <line x1={padding.left} y1={scaleY(val)} x2={width - padding.right} y2={scaleY(val)} stroke="#cbd5e1" strokeWidth="0.3" strokeDasharray="2,2" />
                                <text x={padding.left - 1} y={scaleY(val) + 1} textAnchor="end" fontSize="2.5" fill="#64748b">{val}</text>
                            </g>
                        ))}
                        {[0, 24, 48, 72, 96, 120, 144, 168].map(val => (
                            <g key={val}>
                                <line x1={scaleX(val)} y1={height - padding.bottom} x2={scaleX(val)} y2={padding.top} stroke="#cbd5e1" strokeWidth="0.3" strokeDasharray="2,2" />
                                <text x={scaleX(val)} y={height - padding.bottom + 4} textAnchor="middle" fontSize="2.5" fill="#64748b">{val}h</text>
                            </g>
                        ))}
                        <text x={width/2} y={height-1} textAnchor="middle" fontSize="3" fill="#475569" fontWeight="bold">Age (Hours)</text>
                        <text x={2} y={height/2} textAnchor="middle" fontSize="3" fill="#475569" fontWeight="bold" transform={`rotate(-90, 4, ${height/2})`}>TSB (µmol/L)</text>
                        <path d={createPath('et')} fill="none" stroke="#ef4444" strokeWidth="0.8" />
                        <path d={createPath('pt')} fill="none" stroke="#f59e0b" strokeWidth="0.8" strokeDasharray="2,1" />
                        <g transform={`translate(${width - 30}, ${padding.top})`}>
                            <line x1="0" y1="0" x2="5" y2="0" stroke="#ef4444" strokeWidth="0.8" />
                            <text x={7} y={1} fontSize="2.5" fill="#475569">ET Threshold</text>
                            <line x1="0" y1="4" x2="5" y2="4" stroke="#f59e0b" strokeWidth="0.8" strokeDasharray="2,1" />
                            <text x={7} y={5} fontSize="2.5" fill="#475569">PT Threshold</text>
                        </g>
                        {tsbUmol > 0 && ageHours >= 6 && (
                            <>
                                <circle cx={scaleX(ageHours)} cy={scaleY(tsbUmol)} r="1.5" fill="#3b82f6" stroke="white" strokeWidth="0.5" />
                                <line x1={scaleX(ageHours)} y1={scaleY(tsbUmol)} x2={scaleX(ageHours)} y2={height - padding.bottom} stroke="#3b82f6" strokeWidth="0.2" strokeDasharray="1,1" />
                                <line x1={scaleX(ageHours)} y1={scaleY(tsbUmol)} x2={padding.left} y2={scaleY(tsbUmol)} stroke="#3b82f6" strokeWidth="0.2" strokeDasharray="1,1" />
                                <rect x={padding.left - 9} y={scaleY(tsbUmol) - 2} width="8" height="4" rx="1" fill="#3b82f6" />
                                <text x={padding.left - 5} y={scaleY(tsbUmol) + 1} textAnchor="middle" fontSize="2" fill="white" fontWeight="bold">{Math.round(tsbUmol)}</text>
                                <rect x={scaleX(ageHours) - 4} y={height - padding.bottom} width="8" height="4" rx="1" fill="#3b82f6" />
                                <text x={scaleX(ageHours)} y={height - padding.bottom + 2.8} textAnchor="middle" fontSize="2" fill="white" fontWeight="bold">{ageHours}h</text>
                            </>
                        )}
                    </svg>
                </div>
            )
        });

        const TreatmentCalculator = () => {
            const [gestation, setGestation] = useState(39);
            const [ageHours, setAgeHours] = useState(24);
            const [tsb, setTsb] = useState("");
            const [unit, setUnit] = useState("umol/L");
            const [hasRiskFactors, setHasRiskFactors] = useState(false);
            const [showRiskDetails, setShowRiskDetails] = useState(false);
            const [showRefTables, setShowRefTables] = useState(false);

            const handleNonNegativeInput = (setter) => (e) => { 
                const val = e.target.value;
                if (val === '') {
                    setter('');
                } else {
                    const numVal = Number(val);
                    if (numVal >= 0) setter(numVal);
                }
            };

            const thresholds = useMemo(() => {
                let result = { pt: 0, et: 0 };
                const currentAge = ageHours === '' ? 0 : Number(ageHours);
                if (gestation >= 35) {
                    let colIndex;
                    if (gestation >= 38) colIndex = 1;
                    else if (gestation === 37) colIndex = 2;
                    else if (gestation === 36) colIndex = 3;
                    else colIndex = 4;
                    const ptTable = hasRiskFactors ? MY_PT_RISK : MY_PT_NO_RISK;
                    const etTable = hasRiskFactors ? MY_ET_RISK : MY_ET_NO_RISK;
                    
                    const ptVal = interpolate(currentAge, ptTable, colIndex);
                    const etVal = interpolate(currentAge, etTable, colIndex);
                    
                    if (ptVal === null || etVal === null) {
                         result = { pt: 0, et: 0 }; 
                    } else {
                         result = { pt: ptVal, et: etVal };
                    }
                } else {
                    const lookupGestation = Math.max(23, Math.min(34, Math.floor(gestation)));
                    const table = TABLE_PRETERM[lookupGestation];
                    const res = interpolatePreterm(currentAge, table);
                     if (res === null) {
                         result = { pt: 0, et: 0 }; 
                    } else {
                         result = { pt: res.pt, et: res.et };
                    }
                }
                return { pt: Math.round(result.pt), et: Math.round(result.et) };
            }, [gestation, ageHours, hasRiskFactors]);

            const tsbValue = parseFloat(tsb);
            const tsbUmol = unit === "mg/dL" ? tsbValue * 17.1 : tsbValue;
            let status = "normal", message = "Continue routine monitoring.";
            
            const isTooYoung = (ageHours !== '' && Number(ageHours) < 6);
            
            if (isTooYoung) {
                 status = "normal";
                 message = "No threshold data for infants < 6 hours. Clinical judgement required.";
            } else if (!isNaN(tsbUmol) && thresholds.pt > 0) {
                const escalationThreshold = thresholds.et - 34;
                if (tsbUmol >= thresholds.et) { status = "et"; message = "URGENT Exchange Transfusion indicated. Admit to NICU immediately. Prepare for ET while starting intensive phototherapy and hydration."; }
                else if (tsbUmol >= escalationThreshold) { status = "escalation"; message = "Escalation of Care Required. TSB is within 34 µmol/L (2 mg/dL) of ET threshold. STAT labs, intensive phototherapy, IV hydration, measure TSB q2-3h."; }
                else if (tsbUmol >= thresholds.pt) { status = "pt"; message = "Start Intensive Phototherapy. Measure TSB in 4-24h based on age/risk. Ensure adequate hydration."; }
            }
            
            const getStatusColor = (s) => {
                if (s === "et") return "bg-red-500/20 text-red-900 border-red-500/50 animate-pulse";
                if (s === "escalation") return "bg-orange-500/20 text-orange-900 border-orange-500/50";
                if (s === "pt") return "bg-amber-400/20 text-amber-900 border-amber-400/50";
                return "bg-green-500/20 text-green-900 border-green-500/50";
            };

            return (
                <div className="space-y-6 md:space-y-8">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8 items-start">
                        <div className="lg:col-span-5 space-y-6">
                            <Card title="Patient Details">
                                <div className="space-y-5 md:space-y-6">
                                    <div>
                                        <label className={labelClasses}>Gestation (weeks)</label>
                                        <div className="flex items-center gap-4">
                                            <input type="range" min="23" max="42" value={gestation} onChange={(e) => setGestation(Number(e.target.value))} className="w-full h-3 bg-slate-200/50 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                            <div className="w-20 md:w-24 text-center font-mono text-lg md:text-xl font-bold text-slate-700 bg-white/50 py-2 rounded-xl border border-white/50">{gestation}w</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className={labelClasses}>Age (hours)</label>
                                        <input type="number" min="0" value={ageHours} onChange={handleNonNegativeInput(setAgeHours)} className={inputClasses} />
                                    </div>
                                    <div>
                                        <label className={labelClasses}>Total Serum Bilirubin (TSB)</label>
                                        <div className="flex gap-4">
                                            <input type="number" value={tsb} onChange={(e) => { const val = e.target.value; if (val === '' || Number(val) >= 0) setTsb(val); }} placeholder="Enter value" className={`${inputClasses} flex-1 min-w-0`} />
                                            <div className="relative w-24 md:w-28 shrink-0">
                                                <select value={unit} onChange={(e) => setUnit(e.target.value)} className={`${inputClasses} w-full appearance-none pr-8`}>
                                                    <option value="umol/L">µmol/L</option>
                                                    <option value="mg/dL">mg/dL</option>
                                                </select>
                                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><Icons.ChevronDown size={16} /></div>
                                            </div>
                                        </div>
                                    </div>
                                    {gestation >= 35 && (
                                        <div className="flex flex-col gap-3 p-4 md:p-5 bg-white/40 rounded-xl border border-white/50 shadow-inner">
                                            <div className="flex items-start gap-3 md:gap-4">
                                                <input type="checkbox" id="riskFactors" checked={hasRiskFactors} onChange={(e) => setHasRiskFactors(e.target.checked)} className="mt-1 w-5 h-5 md:w-6 md:h-6 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition-all cursor-pointer" />
                                                <div className="flex-1">
                                                    <label htmlFor="riskFactors" className="text-sm md:text-base font-bold text-slate-700 cursor-pointer select-none block mb-1">
                                                        Neurotoxicity Risk Factors?
                                                    </label>
                                                    <ul className="text-xs md:text-sm text-slate-600 list-disc pl-4 space-y-1">
                                                        <li>
                                                            <span className="cursor-pointer border-b border-dashed border-slate-400 hover:text-blue-600 hover:border-blue-600 transition-colors" onClick={(e) => { e.preventDefault(); setShowRiskDetails(!showRiskDetails); }}>
                                                                Isoimmune haemolytic disease <Icons.Info size={12} className="inline ml-0.5 text-blue-500" />
                                                            </span>, G6PD deficiency or other haemolytic conditions
                                                            
                                                            {showRiskDetails && (
                                                                <div className="mt-2 p-3 bg-blue-50 rounded-lg text-xs text-blue-800 border border-blue-100 animate-fadeIn">
                                                                    <strong>Isoimmune Haemolytic Disease:</strong> Primarily refers to ABO incompatibility (Mother Blood Group 'O') or Rhesus isoimmunisation (Mother Rh Negative) leading to haemolysis in the infant.
                                                                </div>
                                                            )}
                                                        </li>
                                                        <li>Sepsis</li>
                                                        <li>Any significant clinical instability in previous 24 hours</li>
                                                        <li>Albumin &lt; 30g/L (if measured)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Dropdown Reference Tables */}
                                    <div className="mt-4">
                                        <button 
                                            onClick={() => setShowRefTables(!showRefTables)}
                                            className="w-full flex items-center justify-between p-3 bg-white/60 border border-white/50 rounded-xl hover:bg-white/80 transition-all font-bold text-slate-700 text-sm"
                                        >
                                            <span className="flex items-center gap-2"><Icons.Table size={18} className="text-blue-600"/> View Reference Tables (≥35w)</span>
                                            {showRefTables ? <Icons.ChevronUp size={18} /> : <Icons.ChevronDown size={18} />}
                                        </button>
                                        
                                        {showRefTables && (
                                            <div className="mt-2 p-3 bg-white/80 backdrop-blur-md border border-white/50 rounded-xl shadow-sm animate-fadeIn space-y-4">
                                                <div>
                                                    <h5 className="font-bold text-slate-800 text-xs uppercase mb-2">Phototherapy Thresholds (No Risk)</h5>
                                                    <ReferenceTable data={MY_PT_NO_RISK} type="term" />
                                                </div>
                                                <div>
                                                    <h5 className="font-bold text-slate-800 text-xs uppercase mb-2">Phototherapy Thresholds (With Risk)</h5>
                                                    <ReferenceTable data={MY_PT_RISK} type="term" />
                                                </div>
                                                <div className="text-[10px] text-slate-500 italic text-center">Values in µmol/L. Based on Malaysian Paediatric Protocols 5th Edition.</div>
                                            </div>
                                        )}
                                    </div>

                                </div>
                            </Card>
                        </div>
                        <div className="lg:col-span-7 space-y-6">
                            <Card>
                                <div className="flex justify-between items-center mb-4 md:mb-6">
                                    <h3 className="font-bold text-slate-600 uppercase tracking-wider flex items-center gap-2 text-sm md:text-base"><Icons.Activity size={20} /> Clinical Status</h3>
                                    <span className="text-[10px] md:text-xs bg-white/50 backdrop-blur text-slate-600 px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-white/40 shadow-sm font-medium">Malaysian Paeds 5th Ed</span>
                                </div>
                                {tsb && !isTooYoung ? (
                                    <div className={`p-4 md:p-6 rounded-2xl shadow-lg backdrop-blur-md border ${getStatusColor(status).includes('red') ? 'border-red-400/30' : 'border-white/30'} ${getStatusColor(status)} transition-all duration-500 mb-6 md:mb-8`}>
                                        <div className="flex items-start gap-4 md:gap-5">
                                            <div className="p-2 md:p-3 bg-white/30 rounded-full shadow-sm"><Icons.Activity className="shrink-0" size={24} /></div>
                                            <div>
                                                <div className="font-bold text-lg md:text-xl mb-1 md:mb-2 tracking-tight">{status === "et" ? "Urgent Action Required" : status === "escalation" ? "Escalation of Care" : status === "pt" ? "Start Phototherapy" : "Observation"}</div>
                                                <div className="text-sm md:text-base font-medium opacity-90 leading-relaxed">{message}</div>
                                            </div>
                                        </div>
                                    </div>
                                ) : isTooYoung ? (
                                     <div className="p-6 rounded-2xl bg-slate-100/50 border border-slate-200/50 text-center mb-8">
                                        <p className="text-slate-500 font-medium">Infant &lt; 6 hours old. No standard threshold data available. Monitor closely.</p>
                                    </div>
                                ) : (
                                    <div className="p-6 rounded-2xl bg-slate-100/50 border border-slate-200/50 text-center mb-8">
                                        <p className="text-slate-500 font-medium">Enter TSB level to see status recommendation</p>
                                    </div>
                                )}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6">
                                    <div className="bg-amber-100/40 backdrop-blur-sm p-4 md:p-5 rounded-2xl border border-amber-200/50 text-center shadow-sm hover:shadow-md transition-shadow">
                                        <div className="text-xs md:text-sm font-bold text-amber-800/70 uppercase mb-2">Phototherapy</div>
                                        <div className="text-3xl md:text-4xl font-extrabold text-amber-600">{thresholds.pt > 0 ? (unit === "umol/L" ? thresholds.pt : (thresholds.pt / 17.1).toFixed(1)) : "-"}<span className="text-sm font-medium text-amber-600/60 ml-1">{unit}</span></div>
                                    </div>
                                    <div className="bg-red-100/40 backdrop-blur-sm p-4 md:p-5 rounded-2xl border border-red-200/50 text-center shadow-sm hover:shadow-md transition-shadow">
                                        <div className="text-xs md:text-sm font-bold text-red-800/70 uppercase mb-2">Exchange Transfusion</div>
                                        <div className="text-3xl md:text-4xl font-extrabold text-red-600">{thresholds.et > 0 ? (unit === "umol/L" ? thresholds.et : (thresholds.et / 17.1).toFixed(1)) : "-"}<span className="text-sm font-medium text-red-600/60 ml-1">{unit}</span></div>
                                    </div>
                                </div>
                            </Card>
                            <Card title="Treatment Threshold Graph">
                                <ThresholdGraph gestation={gestation} hasRiskFactors={hasRiskFactors} ageHours={ageHours === '' ? 0 : ageHours} tsbUmol={!isNaN(tsbUmol) ? tsbUmol : 0} unit={unit} />
                                {!tsb && <div className="text-center text-xs md:text-sm text-slate-500 mt-4 italic">Enter TSB level to see patient status on graph</div>}
                                <div className="mt-6 md:mt-8 pt-6 border-t border-slate-200/60 text-xs md:text-sm text-slate-500 space-y-3">
                                    <h4 className="font-bold text-slate-700 flex items-center gap-2"><Icons.Info size={16} className="text-blue-500" /> Calculation Logic: Linear Interpolation</h4>
                                    <p className="leading-relaxed">The Malaysian Paediatric Protocols provide threshold values at specific fixed intervals. For ages falling between these points, this tool calculates the exact threshold using <strong>Linear Interpolation</strong>.</p>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 font-mono text-[10px] md:text-xs text-slate-600 overflow-x-auto">
                                        <div>Formula:</div><div className="mt-1 font-bold text-slate-700">Threshold = Lower_Val + (Difference * Ratio)</div>
                                        <div className="mt-2 text-slate-400">Difference = Upper_Val - Lower_Val<br/>Ratio = (Patient_Age - Lower_Time) / (Upper_Time - Lower_Time)</div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        const VolumeCalculators = () => {
            const [weight, setWeight] = useState(3.0);
            const [activeTab, setActiveTab] = useState("double");
            const [showProtocol, setShowProtocol] = useState(false);
            const doubleVolume = (weight * 160).toFixed(0);
            const [pcvInitial, setPcvInitial] = useState(65);
            const [pcvDesired, setPcvDesired] = useState(55);
            const polyVolume = (80 * weight * (pcvInitial - pcvDesired) / pcvInitial).toFixed(0);
            const [hbInitial, setHbInitial] = useState(10);
            const [hbDesired, setHbDesired] = useState(14);
            const anemiaVolume = (80 * weight * (hbDesired - hbInitial) / (22 - ((Number(hbDesired) + Number(hbInitial)) / 2))).toFixed(0);
            
            const handleInput = (setter) => (e) => { 
                const val = e.target.value;
                if (val === '') {
                    setter('');
                } else {
                    const numVal = Number(val);
                    if (numVal >= 0) setter(numVal);
                }
            };

            return (
                <div className="space-y-8">
                    <Card title="Exchange Transfusion Calculator">
                        <div className="flex justify-center mb-8 md:mb-10">
                            <div className="bg-white/40 p-1.5 md:p-2 rounded-xl grid grid-cols-1 sm:grid-cols-3 gap-2 w-full sm:w-auto shadow-inner border border-white/40">
                                {[{ id: "double", label: "Double Volume" }, { id: "poly", label: "Polycythaemia" }, { id: "anemia", label: "Severe Anaemia" }].map((tab) => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-3 rounded-lg text-sm md:text-base font-bold transition-all duration-300 ${activeTab === tab.id ? "bg-white text-teal-600 shadow-md scale-105 ring-1 ring-teal-100" : "text-slate-600 hover:bg-white/20"}`}>{tab.label}</button>
                                ))}
                            </div>
                        </div>
                        <div className="mb-8 md:mb-10 max-w-xs md:max-w-md mx-auto">
                            <label className={labelClasses + " text-center block mb-3"}>Infant Weight (kg)</label>
                            <div className="relative">
                                <input type="number" step="0.1" value={weight} onChange={handleInput(setWeight)} className={`${inputClasses} text-center text-5xl md:text-6xl font-bold h-24 md:h-32 rounded-3xl shadow-sm`} />
                                <span className="absolute right-6 md:right-8 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xl md:text-2xl">kg</span>
                            </div>
                        </div>
                        <div className="bg-white/40 p-6 md:p-10 rounded-3xl border border-white/50 backdrop-blur-md shadow-lg transition-all duration-500">
                            {activeTab === "double" && (
                                <div className="text-center animate-fadeIn">
                                    <h4 className="text-teal-800 font-bold mb-4 uppercase tracking-wide opacity-70 text-sm md:text-base">Double Volume Exchange</h4>
                                    <div className="flex justify-center items-baseline gap-3 mb-4">
                                        <div className="text-7xl md:text-8xl font-black text-teal-600 drop-shadow-md tracking-tighter leading-none">{doubleVolume}</div>
                                        <div className="text-2xl md:text-4xl font-bold text-teal-600/60 pb-2">ml</div>
                                    </div>
                                    <p className="text-sm md:text-base font-medium text-teal-700/80 mb-8">Total Volume (160 ml/kg)</p>
                                    <div className="bg-teal-50/50 p-5 md:p-6 rounded-2xl border border-teal-100/50 text-left max-w-lg mx-auto shadow-sm">
                                        <ul className="space-y-3 text-sm md:text-base text-teal-900">
                                            <li className="flex gap-3"><span className="font-bold text-teal-500">•</span> Aliquot per cycle: <span className="font-bold text-lg">{(weight * 5).toFixed(0)} - {(weight * 6).toFixed(0)} ml</span></li>
                                            <li className="flex gap-3"><span className="font-bold text-teal-500">•</span> Max vol/cycle: 20ml (Term) / 5ml/kg (Preterm/Ill)</li>
                                            <li className="flex gap-3"><span className="font-bold text-teal-500">•</span> Duration: 90-120 minutes (30-35 cycles)</li>
                                        </ul>
                                    </div>
                                </div>
                            )}
                            {activeTab === "poly" && (
                                <div className="space-y-8 animate-fadeIn">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-8">
                                        <div><label className={labelClasses}>Initial PCV (%)</label><input type="number" value={pcvInitial} onChange={handleInput(setPcvInitial)} className={`${inputClasses} text-center font-bold text-lg h-14`} /></div>
                                        <div><label className={labelClasses}>Desired PCV (%)</label><input type="number" value={pcvDesired} onChange={handleInput(setPcvDesired)} className={`${inputClasses} text-center font-bold text-lg h-14`} /></div>
                                    </div>
                                    <div className="text-center pt-8 border-t border-white/30">
                                        <div className="flex justify-center items-baseline gap-3">
                                            <div className="text-6xl md:text-8xl font-black text-teal-600 drop-shadow-md tracking-tighter leading-none">{polyVolume}</div>
                                            <div className="text-2xl md:text-4xl font-bold text-teal-600/60 pb-2">ml</div>
                                        </div>
                                        <p className="text-sm md:text-base font-medium text-teal-700 mt-3">Volume to Exchange (Normal Saline)</p>
                                    </div>
                                </div>
                            )}
                            {activeTab === "anemia" && (
                                <div className="space-y-8 animate-fadeIn">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-8">
                                        <div><label className={labelClasses}>Initial Hb (g/dL)</label><input type="number" value={hbInitial} onChange={handleInput(setHbInitial)} className={`${inputClasses} text-center font-bold text-lg h-14`} /></div>
                                        <div><label className={labelClasses}>Desired Hb (g/dL)</label><input type="number" value={hbDesired} onChange={handleInput(setHbDesired)} className={`${inputClasses} text-center font-bold text-lg h-14`} /></div>
                                    </div>
                                    <div className="text-center pt-8 border-t border-white/30">
                                        <div className="flex justify-center items-baseline gap-3">
                                            <div className="text-6xl md:text-8xl font-black text-teal-600 drop-shadow-md tracking-tighter leading-none">{anemiaVolume}</div>
                                            <div className="text-2xl md:text-4xl font-bold text-teal-600/60 pb-2">ml</div>
                                        </div>
                                        <p className="text-sm md:text-base font-medium text-teal-700 mt-3">Volume of Packed Cells Required</p>
                                    </div>
                                </div>
                            )}
                        </div>

                         {/* CLINICAL PROTOCOL & GUIDELINES */}
                        <div className="mt-8">
                            <button 
                                onClick={() => setShowProtocol(!showProtocol)}
                                className="w-full flex items-center justify-between p-4 bg-white/40 border border-white/50 rounded-2xl hover:bg-white/50 transition-all font-bold text-slate-700"
                            >
                                <span className="flex items-center gap-3"><Icons.BookOpen size={20} className="text-teal-600"/> Clinical Protocol & Guidelines</span>
                                {showProtocol ? <Icons.ChevronUp size={20} /> : <Icons.ChevronDown size={20} />}
                            </button>
                            
                            {showProtocol && (
                                <div className="mt-4 p-6 bg-white/60 backdrop-blur-md border border-white/50 rounded-2xl shadow-sm animate-fadeIn space-y-8 text-sm md:text-base text-slate-700">
                                    
                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.Info size={20}/> Introduction</h4>
                                        <ul className="list-disc pl-5 space-y-2 marker:text-teal-500">
                                            <li>Exchange transfusion (ET) is indicated for severe hyperbilirubinaemia.</li>
                                            <li>Kernicterus has 10% mortality and 70% long term morbidity.</li>
                                            <li>Mortality within 6 hours of ET ranged from zero death to 3 – 4 per 1000 exchanged term infants.</li>
                                            <li>Causes of death include kernicterus itself, necrotizing enterocolitis, infection and procedure related events.</li>
                                        </ul>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.List size={20}/> Indications</h4>
                                        <div className="pl-2 space-y-4">
                                            <div>
                                                <span className="font-bold block text-teal-700 mb-1">Double volume exchange</span>
                                                <ul className="list-disc pl-5 space-y-1 marker:text-teal-500">
                                                    <li>Blood exchange transfusion to lower serum bilirubin level and reduce the risk of brain damage associated with kernicterus.</li>
                                                    <li>Hyperammonemia.</li>
                                                    <li>To remove bacterial toxins in septicaemia.</li>
                                                    <li>To correct life-threatening electrolyte and fluid disorders in acute renal failure.</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <span className="font-bold block text-teal-700 mb-1">Partial exchange transfusion</span>
                                                <ul className="list-disc pl-5 space-y-1 marker:text-teal-500">
                                                    <li>To correct polycythemia with hyperviscosity.</li>
                                                    <li>To correct severe anemia without hypovolaemia.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.Clipboard size={20}/> Preparation of Infant</h4>
                                        <ul className="list-disc pl-5 space-y-2 marker:text-teal-500">
                                            <li>Signed Informed Consent from parent.</li>
                                            <li>Ensure resuscitation equipment is ready and available.</li>
                                            <li>Stabilize and maintain temperature, pulse and respiration.</li>
                                            <li>Obtain peripheral venous access for maintenance IV fluids.</li>
                                            <li>Proper gentle restraint.</li>
                                            <li>Continue feeding the infant; omit only the LAST feed before ET.</li>
                                            <li>If &lt; 4 hours from last feed, empty gastric contents by nasogastric (NG) aspiration before ET.</li>
                                        </ul>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.Droplet size={20}/> Type of Blood</h4>
                                        <ul className="list-disc pl-5 space-y-2 marker:text-teal-500">
                                            <li>Fresh Whole Blood (preferably irradiated), less than 5 days old OR if whole blood is unavailable, reconstitute Packed Red Blood Cells and FFP in a ratio of 3:1.</li>
                                            <li><span className="font-bold">Rh isoimmunisation:</span> ABO compatible, Rh-negative blood.</li>
                                            <li><span className="font-bold">Other conditions:</span> Crossmatch with infant and mother’s blood.</li>
                                            <li><span className="font-bold">In Emergencies:</span> If Blood type unknown (rarely): ‘O’ Rh-negative blood.</li>
                                        </ul>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.Activity size={20}/> Procedure (Exchange Transfusion)</h4>
                                        <div className="pl-2 space-y-4">
                                            <div>
                                                <span className="font-bold block text-teal-700 mb-1">Standard Technique</span>
                                                <ul className="list-disc pl-5 space-y-1 marker:text-teal-500">
                                                    <li>Volume for double exchange is 2x circulating blood volume (Term infant: 2x 80ml/kg = 160ml/kg).</li>
                                                    <li>Connect infant to a cardiac monitor. Take baseline observations.</li>
                                                    <li>Record observations every 15 minutes: heart rate, respiration, oxygen saturation.</li>
                                                    <li>Doctor performs the ET under aseptic technique using a gown and mask.</li>
                                                    <li>Cannulate the umbilical vein to a depth of NOT > 5-7cm in a term infant for catheter tip to be proximal to the portal sinus (for push-pull technique).</li>
                                                    <li>Aliquot for removal and replacement – 5-6mls/kg (Not more than 5-8% of blood volume).</li>
                                                    <li>Maximum volume per cycle – 20mls for term infants, not to exceed 5 ml/kg for ill or preterm infants.</li>
                                                    <li>To monitor vital signs closely – whether infant able to tolerate the aliquot per cycle.</li>
                                                    <li>Nurse keeps a record of the amount of blood given or withdrawn.</li>
                                                </ul>
                                            </div>
                                             <div>
                                                <span className="font-bold block text-teal-700 mb-1">Isovolumetric or Continuous Technique</span>
                                                <ul className="list-disc pl-5 space-y-1 marker:text-teal-500">
                                                    <li>Indication: where UVC cannulation is not possible e.g., umbilical sepsis, failed cannulation.</li>
                                                    <li>Blood is replaced as a continuous infusion into a large peripheral vein while simultaneously removing small amount of blood from an arterial catheter at regular intervals, matching the rate of the infusion closely.</li>
                                                    <li>E.g.: In a 1.5kg infant, total volume to be exchanged is 240mls. Delivering 120mls an hour allowing 10 ml of blood to be removed every 5mins for 2 hours.</li>
                                                    <li>Care and observation for good perfusion of the limb distal to the arterial catheter should be performed as per arterial line care.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </section>
                                    
                                     <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.CheckCircle size={20}/> Points to Note</h4>
                                        <ul className="list-disc pl-5 space-y-2 marker:text-teal-500">
                                            <li>Warm blood with blood warmer OR Pre-warm blood to body temperature using a water bath. Avoid other methods (radiant warmer, hot water) to minimize hemolysis.</li>
                                            <li>Shake blood bag gently every 5-10 cycles to prevent settling of red blood cells.</li>
                                            <li>Rate of exchange: 3-4 minutes per cycle (1 minute ‘out’, 1 minute ‘in’, 1-2 minute ‘pause’ excluding time to discard blood and draw from blood bag).</li>
                                            <li>Syringe should be held vertical during infusion ‘in’ to prevent air embolism.</li>
                                            <li>Total exchange transfusion duration should be 90-120 minutes utilizing 30-35 cycles.</li>
                                            <li>Begin the exchange transfusion with an initial removal of blood (deficit) to avoid cardiac overload.</li>
                                            <li>Routine administration of calcium gluconate is not recommended.</li>
                                            <li>Remove the UVC after procedure unless a second exchange transfusion is anticipated and there was difficulty inserting the UVC.</li>
                                            <li>Continue intensive phototherapy after the procedure.</li>
                                            <li>Repeat exchange transfusion may be required in 6 hours for infants with high rebound SB.</li>
                                            <li>Feed after 4 hours if infant is well and a repeat exchange transfusion is not required.</li>
                                            <li>If infant is anemic (pre-exchange Hb &lt;12 g/dL) give an extra aliquot volume of blood (10mls/kg) at the end of exchange at a rate of 5mls/kg/hr after the exchange transfusion.</li>
                                            <li>Avoid administering any medication during the procedure.</li>
                                        </ul>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.FileText size={20}/> Investigations</h4>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="bg-teal-50/50 p-4 rounded-xl border border-teal-100/50">
                                                <div className="font-bold text-teal-700 mb-2 border-b border-teal-200 pb-1">Pre-Exchange (1st volume removed)</div>
                                                <ul className="list-disc pl-4 text-xs md:text-sm marker:text-teal-400 space-y-1">
                                                    <li>Serum Bilirubin (total, direct, indirect)</li>
                                                    <li>FBC</li>
                                                    <li>Blood C&S via peripheral venous blood</li>
                                                    <li>HIV, Hepatitis B (baseline)</li>
                                                    <li>Others as indicated</li>
                                                </ul>
                                            </div>
                                            <div className="bg-teal-50/50 p-4 rounded-xl border border-teal-100/50">
                                                <div className="font-bold text-teal-700 mb-2 border-b border-teal-200 pb-1">Post-Exchange</div>
                                                <ul className="list-disc pl-4 text-xs md:text-sm marker:text-teal-400 space-y-1">
                                                    <li>Serum Bilirubin (total, direct, indirect)</li>
                                                    <li>FBC</li>
                                                    <li>Capillary blood sugar</li>
                                                    <li>Serum electrolytes and Calcium</li>
                                                    <li>Others as indicated</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-teal-800 flex items-center gap-2 text-base md:text-lg"><Icons.Clock size={20}/> Post ET Management</h4>
                                        <ul className="list-disc pl-5 space-y-2 marker:text-teal-500">
                                            <li>Maintain intensive phototherapy.</li>
                                            <li>Monitor vital signs: Hourly for 4 - 6 hours, and 4 hourly subsequently.</li>
                                            <li>Monitor capillary blood sugar: Hourly for 2 hours following ET.</li>
                                            <li>Check serum Bilirubin 4 - 6 hours after ET.</li>
                                            <li>Maintain strict input and output record.</li>
                                            <li>Monitor appearance of abdomen and lower limbs with routine observations for 24 hours.</li>
                                            <li>Commence feeds after 3-4 hours if clinically stable, abdomen soft and not for repeat ET.</li>
                                            <li>Observe for signs of feed intolerance: vomiting and abdominal distension.</li>
                                        </ul>
                                    </section>

                                    <section className="space-y-2">
                                        <h4 className="font-bold text-red-700 flex items-center gap-2 text-base md:text-lg"><Icons.AlertTriangle size={20}/> Complications</h4>
                                        <div className="bg-red-50/50 p-5 rounded-2xl border border-red-100 text-red-900/90">
                                            <ul className="list-disc pl-5 space-y-2 marker:text-red-400">
                                                <li><strong>Catheter related:</strong> Infection, Haemorrhage, Necrotizing enterocolitis, Air embolism, Vascular events, Portal/Splenic vein thrombosis.</li>
                                                <li><strong>Haemodynamic:</strong> Overload cardiac failure, Hypovolaemic shock, Arrhythmia.</li>
                                                <li><strong>Electrolyte/Metabolic:</strong> Hyperkalemia, Hypocalcemia, Hypoglycaemia or Hyperglycaemia.</li>
                                            </ul>
                                        </div>
                                    </section>
                                </div>
                            )}
                        </div>

                    </Card>
                </div>
            );
        };

        const BINDScore = () => {
            const [mental, setMental] = useState(0);
            const [muscle, setMuscle] = useState(0);
            const [cry, setCry] = useState(0);
            const total = mental + muscle + cry;
            const getInterpretation = (score) => {
                if (score >= 7) return { text: "Advanced ABE", color: "text-red-600", bg: "bg-red-50/50 border-red-200/50", action: "Urgent bilirubin reduction (ET) needed to prevent permanent damage." };
                if (score >= 4) return { text: "Moderate ABE", color: "text-orange-600", bg: "bg-orange-50/50 border-orange-200/50", action: "Urgent intervention likely to reverse acute damage." };
                if (score >= 1) return { text: "Mild ABE", color: "text-amber-600", bg: "bg-amber-50/50 border-amber-200/50", action: "Subtle signs of Acute Bilirubin Encephalopathy." };
                return { text: "Normal", color: "text-green-600", bg: "bg-green-50/50 border-green-200/50", action: "No clinical signs of ABE." };
            };
            const result = getInterpretation(total);
            const SelectGroup = ({ label, value, onChange, options }) => (
                <div className="bg-white/40 p-4 md:p-5 rounded-2xl border border-white/50 shadow-sm transition-all hover:shadow-md">
                    <label className="block text-sm md:text-base font-bold text-slate-700 mb-3 text-center">{label}</label>
                    <select value={value} onChange={onChange} className={`${inputClasses} h-12 md:h-14 font-medium`}>{options.map(opt => <option key={opt.val} value={opt.val}>{opt.text}</option>)}</select>
                </div>
            );
            return (
                <div className="space-y-8">
                    <div className="grid md:grid-cols-1 gap-4 md:gap-6">
                        <SelectGroup label="Mental Status" value={mental} onChange={e => setMental(Number(e.target.value))} options={[{val: 0, text: "Normal (0)"}, {val: 1, text: "Sleepy but arousable; decreased feeding (1)"}, {val: 2, text: "Lethargy, poor suck, irritable/jittery (2)"}, {val: 3, text: "Semi-coma, apnoea, seizures, coma (3)"}]} />
                        <SelectGroup label="Muscle Tone" value={muscle} onChange={e => setMuscle(Number(e.target.value))} options={[{val: 0, text: "Normal (0)"}, {val: 1, text: "Persistent mild to moderate hypotonia (1)"}, {val: 2, text: "Mild/Mod hypertonia alternating with hypotonia, arching (2)"}, {val: 3, text: "Persistent retrocollis & opisthotonus (3)"}]} />
                        <SelectGroup label="Cry Pattern" value={cry} onChange={e => setCry(Number(e.target.value))} options={[{val: 0, text: "Normal (0)"}, {val: 1, text: "High pitched when aroused (1)"}, {val: 2, text: "Shrill, difficult to console (2)"}, {val: 3, text: "Inconsolable or cry weak/absent (3)"}]} />
                    </div>
                    <div className={`p-6 md:p-8 rounded-3xl border backdrop-blur-md shadow-lg transition-all duration-500 ${result.bg}`}>
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-slate-600 font-bold uppercase text-sm tracking-wider">Total Score</span>
                            <span className={`text-4xl md:text-5xl font-black ${result.color}`}>{total}</span>
                        </div>
                        <div className={`text-xl md:text-2xl font-bold mb-3 ${result.color}`}>{result.text}</div>
                        <div className="text-sm md:text-base font-medium text-slate-700 leading-relaxed">{result.action}</div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeView, setActiveView] = useState("calculator");
            useEffect(() => {
                const handleContextMenu = (e) => e.preventDefault();
                const handleKeyDown = (e) => { if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'u')) e.preventDefault(); };
                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);
                return () => { document.removeEventListener('contextmenu', handleContextMenu); document.removeEventListener('keydown', handleKeyDown); };
            }, []);
            const getBackgroundClass = () => {
                switch (activeView) {
                    case "calculator": return "bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100";
                    case "volume": return "bg-gradient-to-br from-emerald-100 via-teal-100 to-cyan-100";
                    case "bind": return "bg-gradient-to-br from-orange-100 via-amber-100 to-yellow-100";
                    case "info": return "bg-gradient-to-br from-pink-100 via-rose-100 to-red-100";
                    default: return "bg-slate-100";
                }
            };
            const getActiveTabClass = (id) => {
                if (activeView !== id) return "text-slate-600 hover:bg-white/30";
                switch (id) {
                    case "calculator": return "bg-white text-indigo-600 shadow-md ring-1 ring-indigo-200 scale-105";
                    case "volume": return "bg-white text-teal-600 shadow-md ring-1 ring-teal-200 scale-105";
                    case "bind": return "bg-white text-orange-600 shadow-md ring-1 ring-orange-200 scale-105";
                    case "info": return "bg-white text-rose-600 shadow-md ring-1 ring-rose-200 scale-105";
                    default: return "";
                }
            };

            return (
                <div className={`min-h-screen font-sans text-slate-800 p-3 md:p-8 lg:p-12 transition-colors duration-700 ease-in-out ${getBackgroundClass()}`}>
                    <div className="max-w-5xl mx-auto space-y-6 md:space-y-10">
                        <header className="bg-white/40 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-xl p-6 md:p-10 flex flex-col items-center justify-center gap-4 text-center transition-all duration-300 hover:shadow-2xl">
                            <div className="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl text-white shadow-lg shadow-blue-500/30 transform transition-transform hover:scale-110"><Icons.Sun size={40} /></div>
                            <div>
                                <h1 className="text-2xl md:text-5xl font-black text-slate-800 tracking-tight">NNJ Protocol</h1>
                                <p className="text-slate-600 font-medium text-xs md:text-lg mt-2 opacity-80">Malaysian Paediatric Protocols 5th Edition (Chapter 21 & 22)</p>
                            </div>
                        </header>
                        <nav className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 w-full">
                            {[{ id: "calculator", label: "Treatment Thresholds", icon: Icons.Activity }, { id: "volume", label: "ET Volume Calc", icon: Icons.Scale }, { id: "bind", label: "BIND Score", icon: Icons.AlertTriangle }, { id: "info", label: "Risk Factors & Info", icon: Icons.BookOpen }].map(item => (
                                <button key={item.id} onClick={() => setActiveView(item.id)} className={`flex flex-col md:flex-row justify-center items-center gap-2 md:gap-3 p-3 md:p-4 rounded-2xl font-bold transition-all duration-300 text-xs md:text-base h-full ${getActiveTabClass(item.id)}`}>
                                    <item.icon size={24} className="scale-75 md:scale-100" /> <span className="text-center">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <main className="animate-slideUp min-h-[500px]">
                            {activeView === "calculator" && <TreatmentCalculator />}
                            {activeView === "volume" && <VolumeCalculators />}
                            {activeView === "bind" && <Card title="Bilirubin Induced Neurological Dysfunction (BIND) Score"><BINDScore /></Card>}
                            {activeView === "info" && (
                                <div className="space-y-8">
                                    <Card title="Risk Factors for Significant NNJ">
                                        <ul className="space-y-4 text-sm md:text-base text-slate-700">
                                            {["Prematurity", "G6PD Deficiency", "Jaundice in first 24 hours", "Mother Blood Group 'O' or Rh Negative", "Sepsis / Meningitis / UTI", "Rapid rise of TSB (>8.5 µmol/L/hr)", "Cephalohematoma or bruising", "Infant of Diabetic Mother"].map((risk, i) => (
                                                <li key={i} className="flex items-center gap-4 bg-white/40 p-4 rounded-2xl border border-white/50 hover:bg-white/60 transition-colors"><Icons.CheckCircle size={22} className="text-rose-500 shrink-0"/> <span className="font-semibold">{risk}</span></li>
                                            ))}
                                        </ul>
                                    </Card>
                                    <Card title="Visual Assessment (Kramer's Rule)">
                                        <div className="overflow-x-auto rounded-2xl border border-white/50 shadow-sm">
                                            <table className="w-full text-xs md:text-base text-left min-w-[300px]">
                                                <thead className="bg-white/60 text-slate-600 uppercase font-bold text-[10px] md:text-sm backdrop-blur-md"><tr><th className="p-3 md:p-5 text-center">Zone</th><th className="p-3 md:p-5 text-center">Area</th><th className="p-3 md:p-5 text-center">Approx TSB (µmol/L)</th></tr></thead>
                                                <tbody className="divide-y divide-white/50 bg-white/30">
                                                    {[{ z: 1, a: "Head and neck", v: "68 - 133" }, { z: 2, a: "Upper trunk", v: "85 - 204" }, { z: 3, a: "Lower trunk & thighs", v: "136 - 272" }, { z: 4, a: "Arms & lower legs", v: "187 - 306" }, { z: 5, a: "Palms & Soles", v: "≥ 306" }].map((row) => (
                                                        <tr key={row.z} className="hover:bg-white/40 transition-colors"><td className="p-3 md:p-5 font-bold text-center">{row.z}</td><td className="p-3 md:p-5 font-medium text-center">{row.a}</td><td className="p-3 md:p-5 font-mono text-center">{row.v}</td></tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="mt-6 p-5 bg-amber-50/60 border border-amber-100/50 rounded-2xl flex gap-4 text-amber-900 text-sm md:text-base shadow-sm backdrop-blur-sm items-center justify-center">
                                            <Icons.AlertTriangle className="shrink-0" size={24} /><span className="font-medium">Visual assessment is unreliable once phototherapy has started. Always measure TSB.</span>
                                        </div>
                                    </Card>
                                </div>
                            )}
                        </main>
                        <footer className="text-center text-slate-500 text-xs md:text-sm py-8 font-medium space-y-2">
                            <p>Disclaimer: This tool is a reference guide based on Malaysian Paediatric Protocols 5th Edition.</p>
                            <p className="opacity-70">Clinical judgment should always take precedence.</p>
                            <div className="flex items-center justify-center gap-2 mt-4 opacity-50 text-[10px] md:text-xs"><Icons.ShieldCheck size={14} /><span>&copy; HKP101995</span></div>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
